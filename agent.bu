variant: fcos
version: 1.5.0

passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKajIx3VWRjhqIrza4ZnVnnI1g2q6NfMfMOcnSciP1Ws lthms@vanellope

storage:
  files:
    - path: /etc/otelcol-contrib/config.yaml
      contents:
        local: files/otelcol.yaml
      mode: 0644
    - path: /etc/rancher/k3s/config.yaml
      contents:
        local: files/k3s-agent-config.yaml
      mode: 0600
    - path: /usr/local/bin/configure-vpc.sh
      mode: 0755
      contents:
        local: files/configure-vpc.sh
    - path: /usr/local/bin/agent-init.sh
      mode: 0755
      contents:
        inline: |
          #!/bin/bash
          set -euo pipefail

          CONFIG_DIR="/etc/rancher/k3s/config.yaml.d"

          # Detect VPC IP and interface (10.0.0.x range, brought up by configure-vpc.service)
          VPC_IP=""
          VPC_IFACE=""
          for i in $(seq 1 60); do
            VPC_LINE=$(ip -4 -o addr show 2>/dev/null | grep '10\.0\.0\.' | head -1)
            if [ -n "$VPC_LINE" ]; then
              VPC_IP=$(echo "$VPC_LINE" | awk '{print $4}' | cut -d/ -f1)
              VPC_IFACE=$(echo "$VPC_LINE" | awk '{print $2}')
              break
            fi
            echo "Waiting for VPC IP in 10.0.0.0/24 (attempt $i/60)..."
            sleep 1
          done

          if [ -z "$VPC_IP" ]; then
            echo "ERROR: Failed to detect VPC IP after 60 attempts"
            exit 1
          fi

          echo "Detected VPC IP: $VPC_IP on $VPC_IFACE"

          # Write k3s drop-in config
          mkdir -p "$CONFIG_DIR"
          cat > "$CONFIG_DIR/50-vpc.yaml" <<EOF
          node-ip: "${VPC_IP}"
          flannel-iface: "${VPC_IFACE}"
          EOF

systemd:
  units:
    - name: install-otelcol.service
      enabled: true
      contents: |
        [Unit]
        Description=Install OpenTelemetry Collector Contrib
        After=network-online.target nss-lookup.target
        Requires=network-online.target nss-lookup.target
        ConditionPathExists=!/var/lib/otelcol-contrib/otelcol-contrib

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStartPre=/bin/bash -c 'for i in $(seq 1 30); do getent hosts github.com > /dev/null 2>&1 && exit 0; echo "Waiting for DNS (attempt $i/30)..."; sleep 2; done; echo "ERROR: DNS not available after 60s"; exit 1'
        ExecStartPre=/bin/mkdir -p /var/lib/otelcol-contrib
        ExecStart=/bin/bash -c 'curl --retry 5 --retry-delay 3 --retry-all-errors -sSfL https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/v0.145.0/otelcol-contrib_0.145.0_linux_amd64.tar.gz | tar xz -C /var/lib/otelcol-contrib'
        ExecStartPost=/bin/chmod +x /var/lib/otelcol-contrib/otelcol-contrib
        ExecStartPost=/bin/chcon -t bin_t /var/lib/otelcol-contrib/otelcol-contrib

        [Install]
        WantedBy=multi-user.target

    - name: otelcol-contrib.service
      enabled: true
      contents: |
        [Unit]
        Description=OpenTelemetry Collector Contrib
        After=install-otelcol.service network-online.target
        Requires=install-otelcol.service

        [Service]
        ExecStart=/var/lib/otelcol-contrib/otelcol-contrib --config /etc/otelcol-contrib/config.yaml
        Restart=always
        RestartSec=5

        [Install]
        WantedBy=multi-user.target

    - name: install-k3s.service
      enabled: true
      contents: |
        [Unit]
        Description=Install k3s binary
        After=network-online.target nss-lookup.target
        Requires=network-online.target nss-lookup.target
        ConditionPathExists=!/var/lib/k3s-bin/k3s

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStartPre=/bin/bash -c 'for i in $(seq 1 30); do getent hosts github.com > /dev/null 2>&1 && exit 0; echo "Waiting for DNS (attempt $i/30)..."; sleep 2; done; echo "ERROR: DNS not available after 60s"; exit 1'
        ExecStartPre=/bin/mkdir -p /var/lib/k3s-bin
        ExecStart=/bin/bash -c 'curl --retry 10 --retry-delay 5 --retry-all-errors -sSfL -o /var/lib/k3s-bin/k3s https://github.com/k3s-io/k3s/releases/download/v1.31.4%%2Bk3s1/k3s'
        ExecStartPost=/bin/chmod +x /var/lib/k3s-bin/k3s
        ExecStartPost=/bin/chcon -t bin_t /var/lib/k3s-bin/k3s

        [Install]
        WantedBy=multi-user.target

    - name: configure-vpc.service
      enabled: true
      contents: |
        [Unit]
        Description=Configure VPC network interface from Vultr metadata
        After=network-online.target
        Requires=network-online.target

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/local/bin/configure-vpc.sh

        [Install]
        WantedBy=multi-user.target

    - name: k3s-agent-init.service
      enabled: true
      contents: |
        [Unit]
        Description=Initialize k3s agent (VPC IP detection)
        After=install-k3s.service configure-vpc.service network-online.target
        Requires=install-k3s.service configure-vpc.service

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/local/bin/agent-init.sh

        [Install]
        WantedBy=multi-user.target

    - name: k3s-agent.service
      enabled: true
      contents: |
        [Unit]
        Description=k3s agent
        After=k3s-agent-init.service network-online.target
        Requires=k3s-agent-init.service

        [Service]
        ExecStart=/var/lib/k3s-bin/k3s agent
        Restart=always
        RestartSec=5

        [Install]
        WantedBy=multi-user.target
