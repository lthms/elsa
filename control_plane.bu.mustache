variant: fcos
version: 1.5.0

passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKajIx3VWRjhqIrza4ZnVnnI1g2q6NfMfMOcnSciP1Ws lthms@vanellope

storage:
  files:
    - path: /etc/otelcol-contrib/config.yaml
      contents:
        local: files/otelcol.yaml
      mode: 0644
    - path: /etc/rancher/k3s/config.yaml
      contents:
        local: files/k3s-config.yaml
      mode: 0600
    - path: /etc/rancher/k3s/tls/server-ca.crt
      contents:
        local: certs/server-ca.crt
      mode: 0644
    - path: /etc/rancher/k3s/tls/server-ca.key
      contents:
        local: certs/server-ca.key
      mode: 0600
    - path: /etc/rancher/k3s/tls/client-ca.crt
      contents:
        local: certs/client-ca.crt
      mode: 0644
    - path: /etc/rancher/k3s/tls/client-ca.key
      contents:
        local: certs/client-ca.key
      mode: 0600
    - path: /usr/local/bin/configure-vpc.sh
      mode: 0755
      contents:
        local: files/configure-vpc.sh
    - path: /usr/local/bin/k3s-init.sh
      mode: 0755
      contents:
        inline: |
          #!/bin/bash
          set -euo pipefail

          IP_FILE="/var/lib/rancher/k3s/.node-ip"
          TLS_DIR="/var/lib/rancher/k3s/server/tls"
          CA_SRC="/etc/rancher/k3s/tls"
          CONFIG_DIR="/etc/rancher/k3s/config.yaml.d"

          # Detect public IP on enp1s0
          PUBLIC_IP=""
          for i in $(seq 1 60); do
            PUBLIC_IP=$(ip -4 -o addr show enp1s0 2>/dev/null | awk '{print $4}' | cut -d/ -f1)
            [ -n "$PUBLIC_IP" ] && break
            echo "Waiting for public IP on enp1s0 (attempt $i/60)..."
            sleep 1
          done

          if [ -z "$PUBLIC_IP" ]; then
            echo "ERROR: Failed to detect public IP on enp1s0 after 60 attempts"
            exit 1
          fi

          echo "Detected public IP: $PUBLIC_IP"

          # Detect VPC IP and interface (10.0.0.x range, brought up by configure-vpc.service)
          VPC_IP=""
          VPC_IFACE=""
          for i in $(seq 1 60); do
            VPC_LINE=$(ip -4 -o addr show 2>/dev/null | grep '10\.0\.0\.' | head -1)
            if [ -n "$VPC_LINE" ]; then
              VPC_IP=$(echo "$VPC_LINE" | awk '{print $4}' | cut -d/ -f1)
              VPC_IFACE=$(echo "$VPC_LINE" | awk '{print $2}')
              break
            fi
            echo "Waiting for VPC IP in 10.0.0.0/24 (attempt $i/60)..."
            sleep 1
          done

          if [ -z "$VPC_IP" ]; then
            echo "ERROR: Failed to detect VPC IP after 60 attempts"
            exit 1
          fi

          echo "Detected VPC IP: $VPC_IP on $VPC_IFACE"

          # Compare with last known VPC IP
          OLD_IP=""
          if [ -f "$IP_FILE" ]; then
            OLD_IP=$(cat "$IP_FILE")
          fi

          if [ "$VPC_IP" != "$OLD_IP" ]; then
            echo "IP changed ($OLD_IP -> $VPC_IP), wiping stale server state"
            rm -rf "$TLS_DIR"
            rm -rf /var/lib/rancher/k3s/server/db
          fi

          # Always copy CA certs
          mkdir -p "$TLS_DIR"
          cp "$CA_SRC"/server-ca.crt "$CA_SRC"/server-ca.key "$TLS_DIR"/
          cp "$CA_SRC"/client-ca.crt "$CA_SRC"/client-ca.key "$TLS_DIR"/

          # Write k3s drop-in config and persist current IP
          mkdir -p "$CONFIG_DIR"
          cat > "$CONFIG_DIR/50-vpc.yaml" <<EOF
          node-ip: "${VPC_IP}"
          tls-san:
            - "${PUBLIC_IP}"
          flannel-iface: "${VPC_IFACE}"
          EOF
          echo "$VPC_IP" > "$IP_FILE"

          # Sync auto-deploy manifests into k3s data volume via symlinks
          mkdir -p /var/lib/rancher/k3s/server/manifests
          find /var/lib/rancher/k3s/server/manifests -maxdepth 1 -type l ! -exec test -e {} \; -delete
          for f in /etc/rancher/k3s/manifests/*.yaml; do
            [ -f "$f" ] && ln -sf "$f" /var/lib/rancher/k3s/server/manifests/
          done
    - path: /usr/local/bin/rebase-os.sh
      mode: 0755
      contents:
        inline: |
          #!/bin/bash
          set -euo pipefail

          STAMP="/var/lib/.rebase-complete"

          if [ -f "$STAMP" ]; then
            echo "Rebase already completed, nothing to do."
            exit 0
          fi

          IMAGE="{{ registry_region }}.vultrcr.com/{{ registry_name }}/elsa-fcos-layer:latest"
          echo "Rebasing to ${IMAGE}..."
          rpm-ostree rebase ostree-unverified-registry:${IMAGE}
          touch "$STAMP"
          systemctl reboot

systemd:
  units:
    - name: rebase-os.service
      enabled: true
      contents: |
        [Unit]
        Description=Rebase to custom FCOS image
        After=network-online.target
        Requires=network-online.target

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/local/bin/rebase-os.sh

        [Install]
        WantedBy=multi-user.target

    - name: otelcol-contrib.service
      enabled: true
      contents: |
        [Unit]
        Description=OpenTelemetry Collector Contrib
        After=rebase-os.service network-online.target
        Requires=rebase-os.service

        [Service]
        ExecStart=/usr/bin/otelcol-contrib --config /etc/otelcol-contrib/config.yaml
        Restart=always
        RestartSec=5

        [Install]
        WantedBy=multi-user.target

    - name: configure-vpc.service
      enabled: true
      contents: |
        [Unit]
        Description=Configure VPC network interface from Vultr metadata
        After=network-online.target
        Requires=network-online.target

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/local/bin/configure-vpc.sh

        [Install]
        WantedBy=multi-user.target

    - name: k3s-init.service
      enabled: true
      contents: |
        [Unit]
        Description=Initialize k3s (IP detection, TLS cert management)
        After=rebase-os.service var-lib-rancher-k3s.mount configure-vpc.service network-online.target
        Requires=rebase-os.service var-lib-rancher-k3s.mount configure-vpc.service

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/local/bin/k3s-init.sh

        [Install]
        WantedBy=multi-user.target

    - name: k3s.service
      enabled: true
      contents: |
        [Unit]
        Description=k3s control plane
        After=k3s-init.service network-online.target
        Requires=k3s-init.service

        [Service]
        ExecStart=/usr/bin/k3s server
        Restart=always
        RestartSec=5

        [Install]
        WantedBy=multi-user.target

    - name: format-vdb.service
      enabled: true
      contents: |
        [Unit]
        Description=Partition /dev/vdb if needed
        DefaultDependencies=no
        After=dev-vdb.device
        Before=local-fs.target

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/bin/bash -c 'blkid /dev/vdb | grep -q TYPE || sgdisk -Z -n 1:0:0 -t 1:8300 /dev/vdb'

        [Install]
        WantedBy=multi-user.target

    - name: mkfs-vdb1.service
      enabled: true
      contents: |
        [Unit]
        Description=Format /dev/vdb1 if needed
        DefaultDependencies=no
        After=dev-vdb1.device format-vdb.service
        Before=local-fs.target

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/bin/bash -c 'blkid /dev/vdb1 | grep -q TYPE || mkfs.ext4 /dev/vdb1'

        [Install]
        WantedBy=multi-user.target

    - name: var-lib-rancher-k3s.mount
      enabled: true
      contents: |
        [Unit]
        Description=Mount k3s data volume
        After=mkfs-vdb1.service
        Requires=mkfs-vdb1.service

        [Mount]
        What=/dev/vdb1
        Where=/var/lib/rancher/k3s
        Type=ext4

        [Install]
        WantedBy=multi-user.target
