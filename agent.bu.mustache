variant: fcos
version: 1.5.0

passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKajIx3VWRjhqIrza4ZnVnnI1g2q6NfMfMOcnSciP1Ws lthms@vanellope

storage:
  files:
    - path: /etc/otelcol-contrib/config.yaml
      contents:
        local: files/otelcol.yaml
      mode: 0644
    - path: /etc/rancher/k3s/config.yaml
      contents:
        local: files/k3s-agent-config.yaml
      mode: 0600
    - path: /usr/local/bin/configure-vpc.sh
      mode: 0755
      contents:
        local: files/configure-vpc.sh
    - path: /usr/local/bin/agent-init.sh
      mode: 0755
      contents:
        inline: |
          #!/bin/bash
          set -euo pipefail

          CONFIG_DIR="/etc/rancher/k3s/config.yaml.d"

          # Detect VPC IP and interface (10.0.0.x range, brought up by configure-vpc.service)
          VPC_IP=""
          VPC_IFACE=""
          for i in $(seq 1 60); do
            VPC_LINE=$(ip -4 -o addr show 2>/dev/null | grep '10\.0\.0\.' | head -1)
            if [ -n "$VPC_LINE" ]; then
              VPC_IP=$(echo "$VPC_LINE" | awk '{print $4}' | cut -d/ -f1)
              VPC_IFACE=$(echo "$VPC_LINE" | awk '{print $2}')
              break
            fi
            echo "Waiting for VPC IP in 10.0.0.0/24 (attempt $i/60)..."
            sleep 1
          done

          if [ -z "$VPC_IP" ]; then
            echo "ERROR: Failed to detect VPC IP after 60 attempts"
            exit 1
          fi

          echo "Detected VPC IP: $VPC_IP on $VPC_IFACE"

          # Write k3s drop-in config
          mkdir -p "$CONFIG_DIR"
          cat > "$CONFIG_DIR/50-vpc.yaml" <<EOF
          node-ip: "${VPC_IP}"
          flannel-iface: "${VPC_IFACE}"
          EOF
    - path: /usr/local/bin/upgrade-os.sh
      mode: 0755
      contents:
        inline: |
          #!/bin/bash
          set -euo pipefail

          FLEETLOCK_URL="http://10.43.0.100:8080"
          MACHINE_ID=$(cat /etc/machine-id)

          echo "Checking for OS image upgrade..."
          rc=0
          rpm-ostree upgrade --unchanged-exit-77 || rc=$?

          if [ "$rc" -eq 77 ]; then
            echo "System is up to date."
            exit 0
          elif [ "$rc" -ne 0 ]; then
            echo "ERROR: rpm-ostree upgrade failed (exit $rc)"
            exit 1
          fi

          echo "Upgrade staged. Acquiring reboot lock..."
          while true; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST "$FLEETLOCK_URL/v1/pre-reboot" \
              -H "fleet-lock-protocol: true" \
              -d "{\"client_params\":{\"id\":\"$MACHINE_ID\",\"group\":\"default\"}}") || true
            if [ "$HTTP_CODE" = "200" ]; then
              echo "Lock acquired. Rebooting..."
              systemctl reboot
              exit 0
            fi
            echo "Lock not available (HTTP $HTTP_CODE), retrying in 30s..."
            sleep 30
          done
    - path: /usr/local/bin/fleetlock-release.sh
      mode: 0755
      contents:
        inline: |
          #!/bin/bash
          set -euo pipefail

          FLEETLOCK_URL="http://10.43.0.100:8080"
          MACHINE_ID=$(cat /etc/machine-id)

          for i in $(seq 1 84); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST "$FLEETLOCK_URL/v1/steady-state" \
              -H "fleet-lock-protocol: true" \
              -d "{\"client_params\":{\"id\":\"$MACHINE_ID\",\"group\":\"default\"}}") || true
            if [ "$HTTP_CODE" = "200" ]; then
              echo "FleetLock released."
              exit 0
            fi
            echo "Waiting for FleetLock server (attempt $i/84)..."
            sleep 5
          done
          echo "WARNING: Failed to release FleetLock after 84 attempts"
          exit 1
    - path: /usr/local/bin/rebase-os.sh
      mode: 0755
      contents:
        inline: |
          #!/bin/bash
          set -euo pipefail

          STAMP="/var/lib/.rebase-complete"

          if [ -f "$STAMP" ]; then
            echo "Rebase already completed, nothing to do."
            exit 0
          fi

          IMAGE="{{ registry_region }}.vultrcr.com/{{ registry_name }}/elsa-fcos-layer:latest"
          echo "Rebasing to ${IMAGE}..."
          rpm-ostree rebase ostree-unverified-registry:${IMAGE}
          touch "$STAMP"
          systemctl reboot

systemd:
  units:
    - name: rebase-os.service
      enabled: true
      contents: |
        [Unit]
        Description=Rebase to custom FCOS image
        After=network-online.target
        Requires=network-online.target

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/local/bin/rebase-os.sh

        [Install]
        WantedBy=multi-user.target

    - name: otelcol-contrib.service
      enabled: true
      contents: |
        [Unit]
        Description=OpenTelemetry Collector Contrib
        After=rebase-os.service network-online.target
        Requires=rebase-os.service

        [Service]
        ExecStart=/usr/bin/otelcol-contrib --config /etc/otelcol-contrib/config.yaml
        Restart=always
        RestartSec=5

        [Install]
        WantedBy=multi-user.target

    - name: configure-vpc.service
      enabled: true
      contents: |
        [Unit]
        Description=Configure VPC network interface from Vultr metadata
        After=network-online.target
        Requires=network-online.target

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/local/bin/configure-vpc.sh

        [Install]
        WantedBy=multi-user.target

    - name: k3s-agent-init.service
      enabled: true
      contents: |
        [Unit]
        Description=Initialize k3s agent (VPC IP detection)
        After=rebase-os.service configure-vpc.service network-online.target
        Requires=rebase-os.service configure-vpc.service

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/local/bin/agent-init.sh

        [Install]
        WantedBy=multi-user.target

    - name: k3s-agent.service
      enabled: true
      contents: |
        [Unit]
        Description=k3s agent
        After=k3s-agent-init.service network-online.target
        Requires=k3s-agent-init.service

        [Service]
        ExecStart=/usr/bin/k3s agent
        Restart=always
        RestartSec=5

        [Install]
        WantedBy=multi-user.target

    - name: upgrade-os.service
      enabled: false
      contents: |
        [Unit]
        Description=Check for and apply OS image upgrades
        After=network-online.target
        Requires=network-online.target
        ConditionPathExists=/var/lib/.rebase-complete

        [Service]
        Type=oneshot
        ExecStart=/usr/local/bin/upgrade-os.sh

    - name: upgrade-os.timer
      enabled: true
      contents: |
        [Unit]
        Description=Periodic OS image upgrade check

        [Timer]
        OnBootSec=5min
        OnUnitActiveSec=6h
        RandomizedDelaySec=30min

        [Install]
        WantedBy=timers.target

    - name: fleetlock-release.service
      enabled: true
      contents: |
        [Unit]
        Description=Release FleetLock after reboot
        After=network-online.target k3s-agent.service
        Requires=network-online.target

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/local/bin/fleetlock-release.sh

        [Install]
        WantedBy=multi-user.target
