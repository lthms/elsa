# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.

variant: fcos
version: 1.5.0

passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - {{ssh_authorized_key}}

storage:
  files:
    - path: /etc/otelcol-contrib/config.yaml
      contents:
        local: files/otelcol.yaml
      mode: 0644
    - path: /etc/rancher/k3s/config.yaml
      contents:
        local: files/k3s-agent-config.yaml
      mode: 0600
    - path: /usr/local/bin/configure-vpc.sh
      mode: 0755
      contents:
        local: files/configure-vpc.sh
    - path: /usr/local/bin/agent-init.sh
      mode: 0755
      contents:
        local: files/agent-init.sh
    - path: /usr/local/bin/upgrade-os.sh
      mode: 0755
      contents:
        local: files/upgrade-os.sh
    - path: /usr/local/bin/fleetlock-release.sh
      mode: 0755
      contents:
        local: files/fleetlock-release.sh
    - path: /usr/local/bin/rebase-os.sh
      mode: 0755
      contents:
        local: files/rebase-os.sh
    - path: /etc/rancher/k3s/tls/server-ca.crt
      contents:
        local: certs/server-ca.crt
      mode: 0644
    - path: /etc/rancher/k3s/tls/agent-cleanup.crt
      contents:
        local: certs/agent-cleanup.crt
      mode: 0644
    - path: /etc/rancher/k3s/tls/agent-cleanup.key
      contents:
        local: certs/agent-cleanup.key
      mode: 0600
    - path: /var/lib/.fresh-deploy
      mode: 0644
      contents:
        inline: ""

systemd:
  units:
    - name: rebase-os.service
      enabled: true
      contents: |
        [Unit]
        Description=Rebase to custom FCOS image
        After=network-online.target
        Requires=network-online.target

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/local/bin/rebase-os.sh

        [Install]
        WantedBy=multi-user.target

    - name: otelcol-contrib.service
      enabled: true
      contents: |
        [Unit]
        Description=OpenTelemetry Collector Contrib
        After=rebase-os.service network-online.target
        Requires=rebase-os.service

        [Service]
        ExecStart=/usr/bin/otelcol-contrib --config /etc/otelcol-contrib/config.yaml
        Restart=always
        RestartSec=5

        [Install]
        WantedBy=multi-user.target

    - name: configure-vpc.service
      enabled: true
      contents: |
        [Unit]
        Description=Configure VPC network interface from Vultr metadata
        After=network-online.target
        Requires=network-online.target

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/local/bin/configure-vpc.sh __VPC_STATIC_IP__

        [Install]
        WantedBy=multi-user.target

    - name: k3s-agent-init.service
      enabled: true
      contents: |
        [Unit]
        Description=Initialize k3s agent (VPC IP detection)
        After=rebase-os.service configure-vpc.service network-online.target
        Requires=rebase-os.service configure-vpc.service

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/local/bin/agent-init.sh

        [Install]
        WantedBy=multi-user.target

    - name: k3s-agent.service
      enabled: true
      contents: |
        [Unit]
        Description=k3s agent
        After=k3s-agent-init.service network-online.target
        Requires=k3s-agent-init.service

        [Service]
        ExecStart=/usr/bin/k3s agent
        Restart=always
        RestartSec=5

        [Install]
        WantedBy=multi-user.target

    - name: upgrade-os.service
      enabled: false
      contents: |
        [Unit]
        Description=Check for and apply OS image upgrades
        After=network-online.target
        Requires=network-online.target
        ConditionPathExists=/var/lib/.rebase-complete

        [Service]
        Type=oneshot
        ExecStart=/usr/local/bin/upgrade-os.sh

    - name: upgrade-os.timer
      enabled: true
      contents: |
        [Unit]
        Description=Periodic OS image upgrade check

        [Timer]
        OnBootSec=5min
        OnUnitActiveSec=6h
        RandomizedDelaySec=30min

        [Install]
        WantedBy=timers.target

    - name: fleetlock-release.service
      enabled: true
      contents: |
        [Unit]
        Description=Release FleetLock after reboot
        After=network-online.target k3s-agent.service
        Requires=network-online.target

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/local/bin/fleetlock-release.sh

        [Install]
        WantedBy=multi-user.target
